<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <title>CineVortex â€“ Search Results</title>
</head>

<body>
  <div id="root">
    <!-- HEADER -->
    <div class="heading">
      <div class="header-left">
        <div class="menu-toggle" id="menu-toggle">
          <span class="material-symbols-outlined">menu</span>
        </div>

        <h1 class="logo">Cine<span>Vortex</span></h1>

        <div class="home-container">
          <a href="project.html" class="home-icon" title="Go to Home">
            <span class="material-symbols-outlined">home</span>
          </a>
        </div>
      </div>

      <!-- Search Bar -->
      <div class="search-container">
                <div class="search">
                    <span class="search-icon material-symbols-outlined">search</span>
                    <input class="search-input" type="search"  id="search-input" placeholder="Search">
                </div>
            </div>
      
      <!-- Profile -->
      <div class="profile"> 
        <img id="profile-img" src="https://cdn-icons-png.flaticon.com/512/6522/6522516.png">
        <div id="dropdown" class="dropdown-menu">
          <ul>
            <li onclick="location.href='profile.html'">Profile</li>
            <li onclick="location.href='settings.html'">Settings</li>
            <li onclick="location.href='login.html'">Login</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- SIDEBAR -->
    <div class="side" id="sidebar">
      <a href="watchlist.html"><div class="p1">Watchlist</div></a>
      <hr>
      <a href="tracker.html"><div class="p1">Tracker</div></a>
      <hr>
      <a href="surprise.html"><div class="p1">Surprise Me</div></a>
      <hr>
      <a href="community.html"><div class="p1">Community</div></a>
    </div>

    <!-- DARK OVERLAY -->
    <div class="overlay" id="overlay"></div>

   <!-- MAIN CONTENT WRAPPER -->
  <div class="s-container">
    <div class="s-profile-box">
    <h2>Search Results</h2>
    <p id="search-query-text"></p>

    <!-- Searched Movie(s) -->
    <div id="searched-movie" class="movies-container"></div>

    <!-- Recommendations -->
    <div class="recommend">
    <h3>Recommended Movies</h3>
    <div id="recommendation-row" class="movies-container recommendations-row"></div>
    </div>
    </div>
  </div>

    <!-- FOOTER -->
    <footer>
      <p>Contact Us</p>
    </footer>

    <!-- Script -->
    <script>
    
      // Get query from URL
const params = new URLSearchParams(window.location.search);
const query = params.get('q')?.trim() || '';

const input = document.getElementById('search-input');
input.value = query;  // Set input value on page load

const searchQueryText = document.getElementById('search-query-text');
const searchedMovieContainer = document.getElementById('searched-movie');
const recommendationRow = document.getElementById('recommendation-row');

searchedMovieContainer.innerHTML = '';
recommendationRow.innerHTML = '';
let searchResults = [];

if (!query) {
  searchQueryText.innerText = 'Please enter a movie title to search.';
  searchedMovieContainer.innerHTML = '';
  recommendationRow.innerHTML = '';
} else {
  searchQueryText.innerText = `Showing results for: "${query}"`;
  const userId = localStorage.getItem("userId");  // Store this during login
  
// Log search interaction
if (userId) {
  fetch('http://localhost:5001/api/log_interaction', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      userId: userId,
      movieId: null,
      action: "search",
      searchQuery: query
    })
  })
  .then(res => res.json())
  .then(data => console.log("Interaction logged:", data))
  .catch(err => console.error("Failed to log search interaction:", err));
}

  fetch('http://localhost:5001/search_and_recommend', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ title: query })
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      searchedMovieContainer.innerHTML = `<p class="no-data">${data.error}</p>`;
      return;
    }

    if (!data.matches || data.matches.length === 0) {
      searchedMovieContainer.innerHTML = '<p class="no-data">No results found :(<br>Try a different keyword or <a href="project.html">return to home</a>.</p>';
      return;
    }
    searchResults = data.matches;

    // Append searched movies on top
    data.matches.forEach(movie => {
      const movieCard = document.createElement('div');
      movieCard.className = 'movie-card';

      const poster = movie.poster_url || 'default_poster.jpg';
      movieCard.innerHTML = `
        <img src="${poster}" alt="${movie.title_with_year}" style="width:100%; border-radius:8px; margin-bottom:10px;">
        <h3>${movie.title_with_year}</h3>
        <p>Rating: ${movie.rating.toFixed(1)}</p>
        <button 
        class="add-watchlist-btn" 
        data-id="${movie._id}" 
        data-title="${movie.title_with_year}" 
        data-poster="${poster}" 
        data-rating="${movie.rating}">
        Add to Watchlist
      </button>

      `;

      searchedMovieContainer.appendChild(movieCard);

      // Append up to 5 recommendations below
      if (movie.recommendations && movie.recommendations.length > 0) {
        movie.recommendations.slice(0, 5).forEach(rec => {
          const recMovie = document.createElement('div');
          recMovie.className = 'rec-movie';
          const recPoster = rec.poster_url || 'default_poster.jpg';
          recMovie.innerHTML = `
            <img src="${recPoster}" alt="${rec.title_with_year}" style="width:100%; border-radius:6px; margin-bottom:8px;">
            <h4>${rec.title_with_year}</h4>
            <p>Rating: ${rec.rating.toFixed(1)}</p>
            <button class="add-watchlist-btn" data-id="${rec.id}">Add to Watchlist</button>

          `;
          recommendationRow.appendChild(recMovie);
        });
      }
    });
  })
  .catch(error => {
    console.error('Error fetching search results:', error);
    searchedMovieContainer.innerHTML = '<p class="no-data">Failed to fetch data. Please try again later.</p>';
  });
}

async function addToWatchlist(movie) {
  const token = localStorage.getItem('token'); // JWT stored after login

  if (!token) {
    alert("Please log in to add to your watchlist.");
    return;
  }

  try {
    const res = await fetch('http://localhost:3000/api/watchlist', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,// Include JWT here
        'Cache-Control': 'no-cache'  
      },
      body: JSON.stringify({
        id: movie._id,               // Your unique movie id attribute
        title: movie.title_with_year,
        poster_url: movie.poster_url,
        rating: movie.rating
      })
    });

    const data = await res.json();
    if (res.ok) {
      alert('Added to watchlist!');
      loadWatchlist();
    } else {
      alert(data.message || 'Failed to add to watchlist.');
    }
  } catch (err) {
    console.error('Error adding to watchlist:', err);
  }
}

document.getElementById('searched-movie').addEventListener('click', async (e) => {
  if (e.target.classList.contains('add-watchlist-btn')) {
    const id = e.target.dataset.id;
    const movie = searchResults.find(m => String(m._id) === id);
    if (!movie) {
      alert('Movie data not found.');
      return;
    }

    await addToWatchlist(movie);
  }
});

      // Handle search input (enter key to trigger search)
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          const query = input.value.trim();
          if (query) {
            window.location.href = `search.html?q=${encodeURIComponent(query)}`;
          }
        }
      });
    </script>
  </div>
  <script src="script.js"></script>
</body>
</html>
